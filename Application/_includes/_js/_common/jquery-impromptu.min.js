(function(e){e.prompt=function(t,n){if(n!==undefined&&n.classes!=undefined&&typeof n.classes==="string"){n={box:n.classes}}e.prompt.options=e.extend({},e.prompt.defaults,n);e.prompt.currentPrefix=e.prompt.options.prefix;var r=e.prompt.options,i=e(document.body),s=e(window);var o='<div class="'+e.prompt.options.prefix+"box "+r.classes.box+'">';if(r.useiframe&&e("object, applet").length>0){o+='<iframe src="javascript:false;" style="display:block;position:absolute;z-index:-1;" class="'+r.prefix+"fade "+r.classes.fade+'"></iframe>'}else{o+='<div class="'+r.prefix+"fade "+r.classes.fade+'"></div>'}o+='<div class="'+r.prefix+" "+r.classes.prompt+'">'+'<form action="javascript:false;" onsubmit="return false;" class="'+r.prefix+'form">'+'<div class="'+r.prefix+"close "+r.classes.close+'">'+r.closeText+"</div>"+'<div class="'+r.prefix+'states"></div>'+"</form>"+"</div>"+"</div>";e.prompt.jqib=e(o).appendTo(i);e.prompt.jqi=e.prompt.jqib.children("."+r.prefix);e.prompt.jqif=e.prompt.jqib.children("."+r.prefix+"fade");if(t.constructor==String){t={state0:{title:r.title,html:t,buttons:r.buttons,position:r.position,focus:r.focus,submit:r.submit}}}e.prompt.options.states={};var u,a;for(u in t){a=e.extend({},e.prompt.defaults.state,{name:u},t[u]);e.prompt.addState(a.name,a);if(e.prompt.currentStateName==="")e.prompt.currentStateName=a.name}var f=e.prompt.jqi.find("."+r.prefix+"states ."+r.prefix+"state").eq(0);e.prompt.goToState(f.data("jqi-name"));e.prompt.jqi.on("click","."+r.prefix+"buttons button",function(t){var n=e(this),i=n.parents("."+r.prefix+"state"),s=e.prompt.options.states[i.data("jqi-name")],o=i.children("."+r.prefix+"message"),u=s.buttons[n.text()]||s.buttons[n.html()],a={};if(u==undefined){for(var f in s.buttons){if(s.buttons[f].title==n.text()||s.buttons[f].title==n.html()){u=s.buttons[f].value}}}e.each(e.prompt.jqi.children("form").serializeArray(),function(e,t){if(a[t.name]===undefined){a[t.name]=t.value}else if(typeof a[t.name]==Array||typeof a[t.name]=="object"){a[t.name].push(t.value)}else{a[t.name]=[a[t.name],t.value]}});var l=new e.Event("impromptu:submit");l.stateName=s.name;l.state=i;i.trigger(l,[u,o,a]);if(!l.isDefaultPrevented()){e.prompt.close(true,u,o,a)}});var l=function(){if(r.persistent){var t=r.top.toString().indexOf("%")>=0?s.height()*(parseInt(r.top,10)/100):parseInt(r.top,10),n=parseInt(e.prompt.jqi.css("top").replace("px",""),10)-t;e("html,body").animate({scrollTop:n},"fast",function(){var t=0;e.prompt.jqib.addClass(r.prefix+"warning");var n=setInterval(function(){e.prompt.jqib.toggleClass(r.prefix+"warning");if(t++>1){clearInterval(n);e.prompt.jqib.removeClass(r.prefix+"warning")}},100)})}else{e.prompt.close(true)}};var c=function(t){var n=window.event?event.keyCode:t.keyCode;if(n==27){l()}if(n==9){var r=e("input,select,textarea,button",e.prompt.getCurrentState());var i=!t.shiftKey&&t.target==r[r.length-1];var s=t.shiftKey&&t.target==r[0];if(i||s){setTimeout(function(){if(!r)return;var e=r[s===true?r.length-1:0];if(e)e.focus()},10);return false}}};e.prompt.position();e.prompt.style();e.prompt.jqif.click(l);s.resize({animate:false},e.prompt.position);e.prompt.jqi.find("."+r.prefix+"close").click(e.prompt.close);e.prompt.jqib.on("keydown",c).on("impromptu:loaded",r.loaded).on("impromptu:close",r.close).on("impromptu:statechanging",r.statechanging).on("impromptu:statechanged",r.statechanged);e.prompt.jqif[r.show](r.overlayspeed);e.prompt.jqi[r.show](r.promptspeed,function(){e.prompt.jqib.trigger("impromptu:loaded")});if(r.timeout>0)setTimeout(e.prompt.close,r.timeout);return e.prompt.jqib};e.prompt.defaults={prefix:"jqi",classes:{box:"",fade:"",prompt:"",close:"",title:"",message:"",buttons:"",button:"",defaultButton:""},title:"",closeText:"&times;",buttons:{Ok:true},loaded:function(e){},submit:function(e,t,n,r){},close:function(e,t,n,r){},statechanging:function(e,t,n){},statechanged:function(e,t){},opacity:.6,zIndex:9999,overlayspeed:"slow",promptspeed:"fast",show:"fadeIn",focus:0,useiframe:false,top:"15%",position:{container:null,x:null,y:null,arrow:null,width:null},persistent:true,timeout:0,states:{},state:{name:null,title:"",html:"",buttons:{Ok:true},focus:0,position:{container:null,x:null,y:null,arrow:null,width:null},submit:function(e,t,n,r){return true}}};e.prompt.currentPrefix=e.prompt.defaults.prefix;e.prompt.currentStateName="";e.prompt.setDefaults=function(t){e.prompt.defaults=e.extend({},e.prompt.defaults,t)};e.prompt.setStateDefaults=function(t){e.prompt.defaults.state=e.extend({},e.prompt.defaults.state,t)};e.prompt.position=function(t){var n=e.fx.off,r=e.prompt.getCurrentState(),i=e.prompt.options.states[r.data("jqi-name")],s=i?i.position:undefined,o=e(window),u=document.body.scrollHeight,a=e(window).height(),f=e(document).height(),l=u>a?u:a,c=parseInt(o.scrollTop(),10)+(e.prompt.options.top.toString().indexOf("%")>=0?a*(parseInt(e.prompt.options.top,10)/100):parseInt(e.prompt.options.top,10));if(t!==undefined&&t.data.animate===false)e.fx.off=true;e.prompt.jqib.css({position:"absolute",height:l,width:"100%",top:0,left:0,right:0,bottom:0});e.prompt.jqif.css({position:"absolute",height:l,width:"100%",top:0,left:0,right:0,bottom:0});if(s&&s.container){var h=e(s.container).offset();if(e.isPlainObject(h)&&h.top!==undefined){e.prompt.jqi.css({position:"absolute"});e.prompt.jqi.animate({top:h.top+s.y,left:h.left+s.x,marginLeft:0,width:s.width!==undefined?s.width:null});c=h.top+s.y-(e.prompt.options.top.toString().indexOf("%")>=0?a*(parseInt(e.prompt.options.top,10)/100):parseInt(e.prompt.options.top,10));e("html,body").animate({scrollTop:c},"slow","swing",function(){})}}else if(s&&s.width){e.prompt.jqi.css({position:"absolute",left:"50%"});e.prompt.jqi.animate({top:s.y||c,left:s.x||"50%",marginLeft:s.width/2*-1,width:s.width})}else{e.prompt.jqi.css({position:"absolute",top:c,left:"50%",marginLeft:e.prompt.jqi.outerWidth()/2*-1})}if(t!==undefined&&t.data.animate===false)e.fx.off=n};e.prompt.style=function(){e.prompt.jqif.css({zIndex:e.prompt.options.zIndex,display:"none",opacity:e.prompt.options.opacity});e.prompt.jqi.css({zIndex:e.prompt.options.zIndex+1,display:"none"});e.prompt.jqib.css({zIndex:e.prompt.options.zIndex})};e.prompt.get=function(t){return e("."+e.prompt.currentPrefix)};e.prompt.addState=function(t,n,r){var i="",s=null,o="",u="",a=e.prompt.options,f=e("."+e.prompt.currentPrefix+"states"),l,c,h=0;n=e.extend({},e.prompt.defaults.state,{name:t},n);if(n.position.arrow!==null)o='<div class="'+a.prefix+"arrow "+a.prefix+"arrow"+n.position.arrow+'"></div>';if(n.title&&n.title!=="")u='<div class="lead '+a.prefix+"title "+a.classes.title+'">'+n.title+"</div>";i+='<div id="'+a.prefix+"state_"+t+'" class="'+a.prefix+'state" data-jqi-name="'+t+'" style="display:none;">'+o+u+'<div class="'+a.prefix+"message "+a.classes.message+'">'+n.html+"</div>"+'<div class="'+a.prefix+"buttons "+a.classes.buttons+'"'+(e.isEmptyObject(n.buttons)?'style="display:none;"':"")+">";for(l in n.buttons){c=n.buttons[l],defbtn=n.focus===h?e.prompt.currentPrefix+"defaultbutton "+a.classes.defaultButton:"";if(typeof c=="object"){i+='<button class="'+a.classes.button+" "+defbtn;if(typeof c.classes!=="undefined"){i+=" "+(e.isArray(c.classes)?c.classes.join(" "):c.classes)+" "}i+='" name="'+a.prefix+"_"+t+"_button"+c.title.replace(/[^a-z0-9]+/gi,"")+'" id="'+a.prefix+"_"+t+"_button"+c.title.replace(/[^a-z0-9]+/gi,"")+'" value="'+c.value+'">'+c.title+"</button>"}else{i+='<button class="'+a.classes.button+" "+defbtn+'" name="'+a.prefix+"_"+t+"_button"+l+'" id="'+a.prefix+"_"+t+"_button"+l+'" value="'+c+'">'+l+"</button>"}h++}i+="</div></div>";s=e(i);s.on("impromptu:submit",n.submit);if(r!==undefined){f.find("#"+e.prompt.currentPrefix+"state_"+r).after(s)}else{f.append(s)}e.prompt.options.states[t]=n;return s};e.prompt.removeState=function(t){var n=e.prompt.getState(t),r=function(){n.remove()};if(n.length===0){return false}if(n.is(":visible")){if(n.next().length>0){e.prompt.nextState(r)}else{e.prompt.prevState(r)}}else{n.slideUp("slow",r)}return true};e.prompt.getState=function(t){return e("#"+e.prompt.currentPrefix+"state_"+t)};e.prompt.getStateContent=function(t){return e.prompt.getState(t)};e.prompt.getCurrentState=function(){return e.prompt.getState(e.prompt.getCurrentStateName())};e.prompt.getCurrentStateName=function(){return e.prompt.currentStateName};e.prompt.goToState=function(t,n,r){var i=e.prompt.get(),s=e.prompt.options,o=e.prompt.getState(t),u=s.states[o.data("jqi-name")],a=new e.Event("impromptu:statechanging");if(typeof n==="function"){r=n;n=false}e.prompt.jqib.trigger(a,[e.prompt.getCurrentStateName(),t]);if(!a.isDefaultPrevented()&&o.length>0){e.prompt.jqi.find("."+e.prompt.currentPrefix+"parentstate").removeClass(e.prompt.currentPrefix+"parentstate");if(n){e.prompt.jqi.find("."+e.prompt.currentPrefix+"substate").not(o).slideUp(s.promptspeed).removeClass("."+e.prompt.currentPrefix+"substate").find("."+e.prompt.currentPrefix+"arrow").hide();e.prompt.jqi.find("."+e.prompt.currentPrefix+"state:visible").addClass(e.prompt.currentPrefix+"parentstate");o.addClass(e.prompt.currentPrefix+"substate")}else{e.prompt.jqi.find("."+e.prompt.currentPrefix+"state").not(o).slideUp(s.promptspeed).find("."+e.prompt.currentPrefix+"arrow").hide()}e.prompt.currentStateName=u.name;o.slideDown(s.promptspeed,function(){var n=e(this);if(typeof u.focus==="string"){n.find(u.focus).eq(0).focus()}else{n.find("."+e.prompt.currentPrefix+"defaultbutton").focus()}n.find("."+e.prompt.currentPrefix+"arrow").show(s.promptspeed);if(typeof r=="function"){e.prompt.jqib.on("impromptu:statechanged",r)}e.prompt.jqib.trigger("impromptu:statechanged",[t]);if(typeof r=="function"){e.prompt.jqib.off("impromptu:statechanged",r)}});if(!n){e.prompt.position()}}return o};e.prompt.nextState=function(t){var n=e("#"+e.prompt.currentPrefix+"state_"+e.prompt.getCurrentStateName()).next();return e.prompt.goToState(n.attr("id").replace(e.prompt.currentPrefix+"state_",""),t)};e.prompt.prevState=function(t){var n=e("#"+e.prompt.currentPrefix+"state_"+e.prompt.getCurrentStateName()).prev();e.prompt.goToState(n.attr("id").replace(e.prompt.currentPrefix+"state_",""),t)};e.prompt.close=function(t,n,r,i){e.prompt.jqib.fadeOut("fast",function(){if(t){e.prompt.jqib.trigger("impromptu:close",[n,r,i])}e.prompt.jqib.remove();e(window).off("resize",e.prompt.position)})};e.fn.prompt=function(t){if(t==undefined)t={};if(t.withDataAndEvents==undefined)t.withDataAndEvents=false;e.prompt(e(this).clone(t.withDataAndEvents).html(),t)}})(jQuery)